---
output: html_document
editor_options: 
  chunk_output_type: console
---
# Fit the Multi-Trait Networks {MTnetworks}
## Multi-Trait Networks  
### Setup Data  
First, we have to do some prep to get the data into list form to run parLapply on the function to fit the networks.  
```{r data frames, eval = T}
# create monochromatic purple color theme for node groups
ipipcolors <- RColorBrewer::brewer.pal(5,"Set3")

# remove unnecessary demographics from data
data20 <- ipip20 %>% select(-RID, -gender) 
colnames(data20)[2:21] <- all_cols20

data50 <- ipip50 %>% select(-RID, -gender) 
colnames(data50)[2:51] <- all_cols50 #c(a, c, n, e, o)

data100 <- ipip100 %>% select(-RID, -gender) 
colnames(data100)[2:101] <- all_cols100
```

Before we can run the networks, we are going to group them in two ways, once by decade and once by year. 
```{r data lists, eval = F}
# transform data to list for use in parLapply for year by year groups
save_fun <- function(d, age, inventory) save(d, file = sprintf("/Volumes/Emorie/projects/age nets/SAPA/01-data/%s/age/%s.RData", inventory, age))
data20 %>%
  select(-age, -age_groups) %>%
  group_by(age2) %>%
  nest() %>%
  mutate(s = map2(data, age2, ~save_fun(.x, .y, "IPIP20")))

data50 %>%
  select(-age, -age_groups) %>%
  group_by(age2) %>%
  nest() %>%
  mutate(s = map2(data, age2, ~save_fun(.x, .y, "IPIP50")))

data100 %>%
  select(-age, -age_groups) %>%
  group_by(age2) %>%
  nest() %>%
  mutate(s = map2(data, age2, ~save_fun(.x, .y, "IPIP100")))

save_fun <- function(d, age, inventory) save(d, file = sprintf("/Volumes/Emorie/projects/age nets/SAPA/01-data/%s/decades/%s.RData", inventory, age))
data20 %>%
  select(-age, -age2) %>%
  filter(age_groups < 80) %>%
  group_by(age_groups) %>%
  nest() %>%
  mutate(s = map2(data, age_groups, ~save_fun(.x, .y, "IPIP20")))

data50 %>%
  select(-age, -age2) %>%
  filter(age_groups < 80) %>%
  group_by(age_groups) %>%
  nest() %>%
  mutate(s = map2(data, age_groups, ~save_fun(.x, .y, "IPIP50")))

data100 %>%
  select(-age, -age2) %>%
  filter(age_groups < 80) %>%
  group_by(age_groups) %>%
  nest() %>%
  mutate(s = map2(data, age_groups, ~save_fun(.x, .y, "IPIP100")))
# 
# datalist20 <- dlply(select(data20, -age, -age_groups), .(age2))
# datalist50 <- dlply(select(data50, -age, -age_groups), .(age2))
# datalist100 <- dlply(select(data100,-age, -age_groups), .(age2))
# 
# # transform data to list for use in parLapply for decade groups
# datalist20gr <- dlply(select(data20, -age, -age2), .(age_groups))
# datalist50gr <- dlply(select(data50, -age, -age2), .(age_groups))
# datalist100gr <- dlply(select(data100,-age, -age2), .(age_groups))
# 
# # remove the age group column
# datalist20gr <- llply(datalist20gr, function(x) x %>% select(-age_groups))
# datalist50gr <- llply(datalist50gr, function(x) x %>% select(-age_groups))
# datalist100gr <- llply(datalist100gr, function(x) x %>% select(-age_groups))
# 
# # remove the later decades with a small sample size
# datalist20gr  <- datalist20gr[!names(datalist20gr) %in% 80:90]
# datalist50gr  <- datalist50gr[!names(datalist50gr) %in% 80:90]
# datalist100gr <- datalist100gr[!names(datalist100gr) %in% 80:90]

# create group membership list based on item codes
ipipgroup20 <- list(a = seq(1,4,1),
                    c = seq(5,8,1),
                    n = seq(9,12,1),
                    e = seq(13,16,1),
                    o = seq(17,20,1)) 

ipipgroup50 <- list(a = seq(1,10,1),
                    c = seq(11,20,1),
                    n = seq(21,30,1),
                    e = seq(31,40,1),
                    o = seq(41,50,1)) 

ipipgroup100 <- list(a = seq(1,20,1),
                     c = seq(21,40,1),
                     n = seq(41,60,1),
                     e = seq(61,80,1),
                     o = seq(81,100,1))
```


```{r}
cor_fun <- function(age, inventory, rule, set, gamma) {
  loadRData <- function(inventory, set, age){
    #loads an RData file, and returns it
    path <- sprintf("/Volumes/Emorie/projects/age nets/SAPA/01-data/%s/%s/%s.RData"
                    , inventory, set, age)
    load(path)
    get(ls()[ls() == "d"])
  }
  x <- loadRData(inventory, set, age)
  cor <- qgraph::cor_auto(x, missing = "pairwise", forcePD = F)
}
```


### Run Models  
```{r, eval = F}
# done <- tibble(file = list.files("/Volumes/Emorie/projects/age nets/SAPA/02-results/multitrait-age/centrality")
#                , set = "age") %>%
#   full_join(tibble(file = list.files("/Volumes/Emorie/projects/age nets/SAPA/02-results/multitrait-decades/centrality")
#                , set = "decades")) %>%
#   separate(file, c("inventory", "age", "rule", "gamma"), sep = "-") %>%
#   mutate(gamma = str_remove_all(gamma, ".RData")
#          , gamma = str_remove_all(gamma, "0")
#          , gamma = as.numeric(paste0(".", gamma))
#          , done = "done")

MT_net_nested <- crossing(
  inventory = c("IPIP20", "IPIP50", "IPIP100")
  , rule = c("median", "max", "min")
  , gamma = c(.25, .5)
)
plan(multisession(workers = 12L))
MT_net_nested <- crossing(
  MT_net_nested
  , set = "age"
  , age = as.character(c(14:59, 62.5, 67.5, 72.5, 78))
) %>% full_join(
  crossing(
    MT_net_nested
    , set = "decades"
    , age = as.character(1:7)
  )
) %>%
  filter(set == "decades" & gamma == .25 & rule == "median") %>%
  # full_join(done) %>%
  # filter(is.na(done)) %>%
  mutate(r = future_pmap(
    list(age, inventory, rule, set, gamma)
    # , .f = EDBqgraph_orig
    , .f = cor_fun
    , .options = furrr_options(
      globals = c("ipipgroup20", "ipipgroup50", "ipipgroup100", "ItemInfo20", "ItemInfo50", "ItemInfo100")
      , packages = c("psych", "qgraph", "plyr", "tidyverse", "RColorBrewer")
    )
    , .progress = T
  ))
closeAllConnections()
gc()
```


### Compile Results  
```{r}
loadRData <- function(file, set, dir, obj){
    path <- sprintf("/Volumes/Emorie/projects/age nets/SAPA/02-results/multitrait-%s/%s/%s",
                               set, dir, file)
    #loads an RData file, and returns it
    load(path)
    get(ls()[grepl(obj, ls())])
}

MT_net_nested <- tibble(
  file = list.files("/Volumes/Emorie/projects/age nets/SAPA/02-results/multitrait-age/network")
  , set = "age"
  ) %>% full_join(tibble(
    file = list.files("/Volumes/Emorie/projects/age nets/SAPA/02-results/multitrait-decades/network")
    , set = "decades"
  )) %>%
  separate(file, c("inventory", "age", "rule", "gamma"), sep = "-", remove = F) %>%
  mutate(gamma = str_remove_all(gamma, ".RData")
         , gamma = str_remove_all(gamma, "0")
         , gamma = paste0(".", gamma)) %>%
  mutate(net = pmap(list(file, set, "network", "graph"), possibly(loadRData, NA_real_))
         , mat = pmap(list(file, set, "cor", "cor"), possibly(loadRData, NA_real_))
         # , centrality = pmap(list(file, set, "centrality", "cent"), possibly(loadRData, NA_real_))
         ) 

MT_net_nested <- MT_net_nested %>% mutate(pd = map_lgl(mat, corpcor::is.positive.definite))
```


Now, to avoid redundancy, we will make create a `tibble` with the networks and centrality stored as list columns, which will make it easier to run functions on them efficiently.  
```{r mt nets nested, eval = F}
# MT_net_nested <- 
#   tibble(inventory = "IPIP20",
#          age = names(allcorsNgraphs20),
#          results = allcorsNgraphs20,
#          centrality = allcentrality20) %>%
#          mutate(cols = lapply(1:nrow(.), function(x)all_cols20)) %>%
#   bind_rows(tibble(inventory = "IPIP50",
#          age = names(allcorsNgraphs50),
#          results = allcorsNgraphs50,
#          centrality = allcentrality50) %>%
#          mutate(cols = lapply(1:nrow(.), function(x)all_cols50))) %>%
#   bind_rows(tibble(inventory = "IPIP100",
#          age = names(allcorsNgraphs100),
#          results = allcorsNgraphs100,
#          centrality = allcentrality100) %>%
#          mutate(cols = lapply(1:nrow(.), function(x)all_cols100))) %>%
#   mutate(mat = map(results, ~.[[1]]),
#          net = map(results, ~.[[2]]))
# 
# MT_net_nested_gr <- tibble(age_group = names(allcorsNgraphs20gr), 
#     results = allcorsNgraphs20gr,  cols = list(all_cols20), inventory = "IPIP20") %>%
#   bind_rows(tibble(age_group = names(allcorsNgraphs50gr), results = allcorsNgraphs50gr, 
#     cols = list(all_cols50), inventory = "IPIP50")) %>%
#   bind_rows(tibble(age_group = names(allcorsNgraphs100gr), results = allcorsNgraphs100gr, 
#     cols = list(all_cols100), inventory = "IPIP100")) %>%
#   mutate(mat = map(results, function(x) x[[1]]),
#          net = map(results, function(x) x[[2]]))
```


#### Reshape Results  
```{r extract edges}
# load(url(sprintf("%s/02-results/mt_nested_nets.RData?raw=true", data_path)))
getEdges.df <- function(x, invn) {
  cols <- switch (invn,
    IPIP20 = all_cols20
    , IPIP50 = all_cols50
    , IPIP100 = all_cols100
  )
    y <- qgraph::getWmat(x)
    y[upper.tri(y, diag = T)] <- NA
    colnames(y) <- cols; rownames(y) <- cols
    nvar <- dim(y)[2]
    df <- y %>%
      data.frame() %>%
      rownames_to_column("from") %>%
      gather(key = to, value = weight, -from, na.rm = T) %>%
      mutate(edge = paste(from, to, sep = "_"))
    return(df)
}

MT_net_nested <- MT_net_nested %>%
  mutate(edges.df = map2(net, inventory, getEdges.df),
         cors.df = map2(mat, inventory, possibly(getEdges.df, NA_real_)))

# MT_net_nested_gr <- MT_net_nested_gr %>%
#   mutate(edges.df = map2(net, cols, getEdges.df),
#          cors.df = map2(mat, cols, getEdges.df))

ex_fun <- function(x){x[[1]]}
```

## N = 500 Across Ages  
### Run Models  
```{r run n500 nets, eval = F}
# done <- tibble(file = list.files("/Volumes/Emorie/projects/age nets/SAPA/02-results/multitrait-age-500/network")
  #              , set = "age") %>%
  # separate(file, c("inventory", "age", "rule", "gamma"), sep = "-") %>%
  # mutate(gamma = str_remove_all(gamma, ".RData")
  #        , gamma = str_remove_all(gamma, "0")
  #        , gamma = as.numeric(paste0(".", gamma))
  #        , done = "done")

MT_net_nested_500 <- crossing(
  inventory = c("IPIP20", "IPIP50", "IPIP100")
  , rule = c("median", "max", "min")
  , gamma = c(.25, .5)
)
plan(multisession(workers = 12L))
crossing(
  MT_net_nested_500
  , set = "age"
  , age = as.character(c(14:59, 62.5, 67.5, 72.5, 78))
) %>% 
  full_join(
    crossing(
      MT_net_nested_500
      , set = "decades"
      , age = as.character(1:7)
    )
) %>%
  # full_join(done) %>%
  # filter(is.na(done)) %>%
  filter(age %in% c(2,6) & inventory == "IPIP50") %>%
  arrange(desc(inventory)) %>%
  mutate(r = 
           future_pmap(
           # pmap(
             list(age, inventory, rule, set, gamma)
             , .f = EDBqgraph_n500
             , .options = furrr_options(
               globals = c("ipipgroup20", "ipipgroup50", "ipipgroup100", "ItemInfo20", "ItemInfo50", "ItemInfo100")
               , packages = c("psych", "qgraph", "plyr", "tidyverse", "RColorBrewer")
               )
             , .progress = T
             ))
closeAllConnections()
gc()
```


### Compile Results  
```{r compile n500 nets, eval = F}
loadRData <- function(file, set, dir, obj){
    path <- sprintf("/Volumes/Emorie/projects/age nets/SAPA/02-results/multitrait-%s-500/%s/%s",
                               set, dir, file)
    #loads an RData file, and returns it
    load(path)
    get(ls()[grepl(obj, ls())])
}

MT_net_nested_500 <- tibble(
  file = list.files("/Volumes/Emorie/projects/age nets/SAPA/02-results/multitrait-age-500/network")
  , set = "age"
  ) %>% 
  full_join(tibble(
  file = list.files("/Volumes/Emorie/projects/age nets/SAPA/02-results/multitrait-decades-500/network")
  , set = "decades"
  )) %>%
  separate(file, c("inventory", "age", "rule", "gamma"), sep = "-", remove = F) %>%
  mutate(gamma = str_remove_all(gamma, ".RData")
         , gamma = str_remove_all(gamma, "0")
         , gamma = paste0(".", gamma)) %>%
  mutate(net = pmap(list(file, set, "network", "graph"), possibly(loadRData, NA_real_))
         # , mat = pmap(list(file, set, "cor", "cor"), possibly(loadRData, NA_real_))
         # , centrality = pmap(list(file, set, "centrality", "cent"), possibly(loadRData, NA_real_))
         ) 

call_edges_df <- function(net, invn){
  names(net) <- 1:100
  ldply(net, function(x) getEdges.df(x, invn))
}

MT_net_nested_500 <- MT_net_nested_500 %>% 
  mutate(edges.df = map2(net, inventory, call_edges_df)) %>% 
  select(-net)
save(MT_net_nested_500
     , file = "/Volumes/Emorie/projects/age nets/SAPA/02-results/multitrait-age-500/nested-nets-500.RData")
```

### Summarize Results  
```{r summarize n500 nets, eval = F}
sum_fun <- function(x){
  x %>% group_by(from, to, edge) %>% 
    summarize(upper = quantile(weight, probs =.975)
              , lower = quantile(weight, probs =.025)
              , estimate = mean(weight)
      ) %>%
    ungroup() 
}
MT_net_nested_500 <- MT_net_nested_500  %>%
  mutate(edges.df = map(edges.df, sum_fun))

net_fun <- function(d, inventory){
  nitem <- str_remove_all(inventory, "[A-Z a-z]") %>% as.numeric()
  grps <- if(nitem == 20) ipipgroup20 else if(nitem == 50) ipipgroup50 else ipipgroup100
  iinfo <- if(nitem == 20) ItemInfo20 else if(nitem == 50) ItemInfo50 else ItemInfo100
  
  # graph setups
  ipipcolors <- RColorBrewer::brewer.pal(5,"Set3")
  edgecolors <- c("orchid2", "#08519C")
  
  graph <- qgraph::qgraph(d %>% select(from, to, estimate)
                          , layout = "spring"
                          , node.width = 1
                          , edge.width = 2
                          , label.font = 2
                          , label.cex = .7
                          , labels = T
                          , esize = 3
                          , DoNotPlot = T
                          , directed = F
                          , groups = grps
                          , color = ipipcolors)
  graph$graphAttributes$Edges$lty[graph$Edgelist$weight < 0] <- 2
  graph$graphAttributes$Edges$color <- ifelse(graph$Edgelist$weight < 0, 
                                              edgecolors[1], edgecolors[2])
  dark_colors <- c("#9E9AC8", "#6A51A3", "#3F007D")
  graph$graphAttributes$Nodes$label.color[graph$graphAttributes$Nodes$color 
                                          %in% dark_colors] <- "white"
  return(graph)
}

MT_net_nested_500 <- MT_net_nested_500 %>%
  mutate(net = map2(edges.df, inventory, net_fun))

save(MT_net_nested_500
     , file = "/Volumes/Emorie/projects/age nets/SAPA/02-results/multitrait-age-500/nested-nets_small.RData")
```

```{r}
load("/Volumes/Emorie/projects/age nets/SAPA/02-results/multitrait-age-500/nested-nets_small.RData")
```


## Additional Sensitivity Analyses  

### forcePD = F  

```{r no forcepd, eval = F}
cfun <- function(age, set, inventory){
  loadRData <- function(inventory, set, age){
    #loads an RData file, and returns it
    path <- sprintf("/Volumes/Emorie/projects/age nets/SAPA/01-data/%s/%s/%s.RData"
                    , inventory, set, age)
    print(path)
    load(path)
    get(ls()[ls() == "d"])
  }
  x <- loadRData(inventory, set, age)
  cor <- qgraph::cor_auto(x, missing = "pairwise")
}
plan(multisession(workers = 12L))
MT_net_nested2 <- crossing(
  inventory = c("IPIP20", "IPIP50", "IPIP100")
  , set = "age"
  , age = as.character(c(14:59, 62.5, 67.5, 72.5, 78))
) %>% full_join(
  crossing(
    inventory = c("IPIP20", "IPIP50", "IPIP100")
    , set = "decades"
    , age = as.character(1:7)
  )
) %>%
  mutate(cor = future_pmap(list(age, set, inventory)
                    , possibly(cfun, NA_real_)
                    , .options = furrr_options(
      globals = c("ipipgroup20", "ipipgroup50", "ipipgroup100", "ItemInfo20", "ItemInfo50", "ItemInfo100")
      , packages = c("psych", "qgraph", "plyr", "tidyverse", "RColorBrewer")
    )
    , .progress = T
                    )
  )
closeAllConnections()

MT_net_nested2 <- MT_net_nested2 %>%
  mutate(pd = map_lgl(cor, possibly(corpcor::is.positive.definite, NA_real_)))

MT_net_nested2 %>% group_by(inventory, set, pd) %>%
  tally()
```

### N = N for 60's group, forcePD = F  
```{r cfun3917, eval = F}
cfun3917 <- function(age, set, inventory){
  loadRData <- function(inventory, set, age){
    #loads an RData file, and returns it
    path <- sprintf("/Volumes/Emorie/projects/age nets/SAPA/01-data/%s/%s/%s.RData"
                    , inventory, set, age)
    print(path)
    load(path)
    get(ls()[ls() == "d"])
  }
  x <- loadRData(inventory, set, age)
  
  sz <- if(nrow(x) < 3917) nrow(x) else 3917
  rplc <- if(nrow(x) < 3917) T else F
  
  set.seed(4)
  xl <- lapply(1:10, function(z) x[sample(nrow(x), size = sz, replace = rplc),])
  
  cor <- lapply(xl, function(z) qgraph::cor_auto(z, missing = "pairwise"))
}

plan(multisession(workers = 12L))
MT_net_nested5 <- crossing(
  inventory = c("IPIP20", "IPIP50", "IPIP100")
  , set = "age"
  , age = as.character(c(14:59, 62.5, 67.5, 72.5, 78))
) %>% full_join(
  crossing(
    inventory = c("IPIP20", "IPIP50", "IPIP100")
    , set = "decades"
    , age = as.character(1:7)
  )
) %>%
  mutate(cor = future_pmap(list(age, set, inventory)
                    , possibly(cfun3197, NA_real_)
                    , .options = furrr_options(
      globals = c("ipipgroup20", "ipipgroup50", "ipipgroup100", "ItemInfo20", "ItemInfo50", "ItemInfo100")
      , packages = c("psych", "qgraph", "plyr", "tidyverse", "RColorBrewer")
    )
    , .progress = T
                    )
  )
closeAllConnections()


MT_net_nested5 <- MT_net_nested5 %>%
  mutate(pd = map(cor, ~map_lgl(., corpcor::is.positive.definite)))

MT_net_nested5 %>% mutate(perc = map_dbl(pd, ~sum(.)/10)) %>%
  group_by(inventory, set) %>% 
  summarize_at(vars(perc), lst(min, max, mean, median))
```

### N = 1000, forcePD = F  
```{r n1000, eval = F}
cfun1000 <- function(age, set, inventory){
  loadRData <- function(inventory, set, age){
    #loads an RData file, and returns it
    path <- sprintf("/Volumes/Emorie/projects/age nets/SAPA/01-data/%s/%s/%s.RData"
                    , inventory, set, age)
    print(path)
    load(path)
    get(ls()[ls() == "d"])
  }
  x <- loadRData(inventory, set, age)
  
  sz <- if(nrow(x) < 1000) nrow(x) else 1000
  rplc <- if(nrow(x) < 1000) T else F
  
  set.seed(4)
  xl <- lapply(1:10, function(z) x[sample(nrow(x), size = sz, replace = rplc),])
  
  cor <- lapply(xl, function(z) qgraph::cor_auto(z, missing = "pairwise"))
}

plan(multisession(workers = 12L))
MT_net_nested4 <- crossing(
  inventory = c("IPIP20", "IPIP50", "IPIP100")
  , set = "age"
  , age = as.character(c(14:59, 62.5, 67.5, 72.5, 78))
) %>% full_join(
  crossing(
    inventory = c("IPIP20", "IPIP50", "IPIP100")
    , set = "decades"
    , age = as.character(1:7)
  )
) %>%
  mutate(cor = future_pmap(list(age, set, inventory)
                    , possibly(cfun3197, NA_real_)
                    , .options = furrr_options(
      globals = c("ipipgroup20", "ipipgroup50", "ipipgroup100", "ItemInfo20", "ItemInfo50", "ItemInfo100")
      , packages = c("psych", "qgraph", "plyr", "tidyverse", "RColorBrewer")
    )
    , .progress = T
                    )
  )
closeAllConnections()

MT_net_nested4 <- MT_net_nested4 %>%
  mutate(pd = map(cor, ~map_lgl(., corpcor::is.positive.definite)))

MT_net_nested4 %>% mutate(perc = map_dbl(pd, ~sum(.)/10)) %>%
  group_by(inventory, set) %>% 
  summarize_at(vars(perc), lst(min, max, mean, median))
```

### Remove Multicollinear Items, forcePD = F  

```{r rem items, eval = F}
c_fun <- function(age, set, inventory){
  loadRData <- function(inventory, set, age){
    #loads an RData file, and returns it
    path <- sprintf("/Volumes/Emorie/projects/age nets/SAPA/01-data/%s/%s/%s.RData"
                    , inventory, set, age)
    print(path)
    load(path)
    get(ls()[ls() == "d"])
  }
  x <- loadRData(inventory, set, age)
  
  cr <- cor_auto(x)
  cr[upper.tri(cr, diag = T)] <- NA
  cr[abs(cr) <= .65] <- NA
  cr_red <- cr %>% data.frame() %>%
    rownames_to_column("V1") %>%
    pivot_longer(names_to = "V2", values_to = "r", cols = -V1, values_drop_na = T)
  rem <- unique(cr_red$V1)
  if(length(rem) > 0){
    rem <- which(colnames(x) %in% rem)
    x2 <- x[, -rem]
  } else {
    x2 <- x
  }
  cr2 <- cor_auto(x2)
  return(list(cr = cr2, rem = rem))
}

plan(multisession(workers = 12L))
MT_net_nested6 <- crossing(
  inventory = c("IPIP20", "IPIP50", "IPIP100")
  , set = "age"
  , age = as.character(c(14:59, 62.5, 67.5, 72.5, 78))
) %>% full_join(
  crossing(
    inventory = c("IPIP20", "IPIP50", "IPIP100")
    , set = "decades"
    , age = as.character(1:7)
  )
) %>%
  filter(set == "decades") %>%
  mutate(cor = future_pmap(list(age, set, inventory)
                    , c_fun
                    , .options = furrr_options(
      globals = c("ipipgroup20", "ipipgroup50", "ipipgroup100", "ItemInfo20", "ItemInfo50", "ItemInfo100")
      , packages = c("psych", "qgraph", "plyr", "tidyverse", "RColorBrewer")
    )
    , .progress = T
                    )
  )
closeAllConnections()

MT_net_nested6 %>%
  mutate(rem = map(cor, ~(.)$rem)
         , cor = map(cor, ~(.)$cr)
         , nrem = map_dbl(rem, length)
         , pd = map_lgl(cor, corpcor::is.positive.definite)) %>%
  # filter(inventory == "IPIP50") 
  group_by(inventory, set, pd) %>%
  tally() %>%
  group_by(inventory, set) %>%
  mutate(perc = n/sum(n))
```

### Remove Multicollinear Items, forcePD = F, N = N for 60's group  
```{r c_fun3917, eval = F}
c_fun3917 <- function(age, set, inventory){
  loadRData <- function(inventory, set, age){
    #loads an RData file, and returns it
    path <- sprintf("/Volumes/Emorie/projects/age nets/SAPA/01-data/%s/%s/%s.RData"
                    , inventory, set, age)
    print(path)
    load(path)
    get(ls()[ls() == "d"])
  }
  x <- loadRData(inventory, set, age)
  
  sz <- if(nrow(x) < 3917) nrow(x) else 3917
  rplc <- if(nrow(x) < 3917) T else F
  
  set.seed(4)
  xl <- lapply(1:10, function(z) x[sample(nrow(x), size = sz, replace = rplc),])
  
  crl <- lapply(1:10, function(z){
    cr <- cor_auto(xl[[z]])
    cr[upper.tri(cr, diag = T)] <- NA
    cr[abs(cr) <= .65] <- NA
    cr_red <- cr %>% data.frame() %>%
      rownames_to_column("V1") %>%
      pivot_longer(names_to = "V2", values_to = "r", cols = -V1, values_drop_na = T)
    rem <- unique(cr_red$V1)
    if(length(rem) > 0){
      rem <- which(colnames(xl[[z]]) %in% rem)
      x2 <- xl[[z]][, -rem]
    } else {
      x2 <- xl[[z]]
    }
    cr2 <- cor_auto(x2)
  })
}

plan(multisession(workers = 12L))
MT_net_nested8 <- crossing(
  inventory = c("IPIP20", "IPIP50", "IPIP100")
  , set = "age"
  , age = as.character(c(14:59, 62.5, 67.5, 72.5, 78))
) %>% full_join(
  crossing(
    inventory = c("IPIP20", "IPIP50", "IPIP100")
    , set = "decades"
    , age = as.character(1:7)
  )
) %>%
  filter(set == "decades") %>%
  filter(inventory == "IPIP100") %>%
  mutate(cor = future_pmap(list(age, set, inventory)
                    , c_fun3917
                    , .options = furrr_options(
      globals = c("ipipgroup20", "ipipgroup50", "ipipgroup100", "ItemInfo20", "ItemInfo50", "ItemInfo100")
      , packages = c("psych", "qgraph", "plyr", "tidyverse", "RColorBrewer")
    )
    , .progress = T
                    )
  )
closeAllConnections()

MT_net_nested8 %>%
  bind_rows(MT_net_nested8) %>%
  mutate(pd = map(cor, ~map_lgl(., corpcor::is.positive.definite))) %>% 
  mutate(perc = map_dbl(pd, ~sum(.)/10),
         perc = ifelse(perc >= .5, 1, 0)) %>%
  # filter(inventory != "IPIP100") %>%
  group_by(inventory, set, perc) %>%
  tally() %>%
  group_by(inventory, set) %>%
  mutate(perc2 = n/sum(n))

```

