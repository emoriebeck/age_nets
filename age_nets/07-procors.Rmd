---
output: html_document
editor_options: 
  chunk_output_type: console
---
# Profile Correlations {#procors}  
Next, we calculate profile correlations to test the stability of edges across all possible pairwise combinations of ages. A strong parallel correlation indicates that the weight of the edges is associated across two ages. We then map these profile correlations onto a heat map that displays the pairwise profile correlations. We would expect to see the strongest profile correlations cluster on the diagonal of heatmap -- that is between ages that are adjacent or near in age.  
## Multi-Trait  
```{r mt procor}
mat_fun <- function(df){
  df <- df %>% mutate(age = as.numeric(age))
  df <- unclass(df) %>% data.frame
  rownames(df) <- df$age
  df <- df %>% select(-age) 
  cor(t(df), use = "pairwise")
  }

# change the direction of the data 
MT_procor <- MT_net_nested %>% 
  select(inventory, age, rule, gamma, set, edges.df) %>%
  full_join(MT_net_nested_500 %>% 
              select(inventory, age, rule, gamma, set, edges.df) %>%
              mutate(set = "500"
                     , edges.df = map(edges.df, ~(.) %>% select(from, to, edge, weight = estimate))))

bwwi_procor <- MT_procor %>%
  mutate(edges.df = map(edges.df, ~(.) %>% 
                          separate(from, into = c("from_factor", "from_item"), 1) %>%
                          separate(to, into = c("to_factor", "to_item"), 1))
         , between = map(edges.df, ~(.) %>% 
                            filter(from_factor != to_factor) %>%
                            select(edge, weight) %>% 
                            spread(key = edge, value = weight))
         , within = map(edges.df, ~(.) %>% 
                            filter(from_factor == to_factor) %>%
                            select(edge, weight) %>% 
                            spread(key = edge, value = weight))) %>%
  select(-edges.df) %>%
  pivot_longer(cols = c("between", "within")
               , names_to = "type"
               , values_to = "data") %>%
  group_by(inventory, rule, gamma, set, type) %>%
  nest() %>% 
  ungroup() %>%
  mutate(data = map(data, ~(.) %>% unnest(data))
         # , data = map(data, mat_fun)
         , procor = map(data, possibly(mat_fun, NA_real_)))

MT_procor <- MT_procor %>%
  mutate(edges.df = map(edges.df, ~(.) %>% select(-from, -to) %>% spread(key = edge, value = weight))) %>%
  group_by(inventory, rule, gamma, set) %>%
  nest() %>%
  ungroup() %>%
  mutate(data = map(data, ~(.) %>% unnest(edges.df))
         # , data = map(data, mat_fun)
         , procor = map(data, possibly(mat_fun, NA_real_)))
# 
# # separate out differentiation from coherence
# edges.mat50bw <- MT_net_nested %>% 
#        filter(inventory == "IPIP50") %>% unnest(edges.df) %>%
#        separate(from, into = c("from_factor", "from_item"), 1) %>%
#        separate(to, into = c("to_factor", "to_item"), 1) %>%
#        filter(from_factor != to_factor) %>%
#        select(age, weight, edge) %>%
#        spread(key = edge, value = weight) %>%
#        unclass %>% data.frame
# 
# # separate out coherence from differentiation 
# edges.mat50wi <- MT_net_nested %>% 
#        filter(inventory == "IPIP50") %>% unnest(edges.df) %>%
#        separate(from, into = c("from_factor", "from_item"), 1) %>%
#        separate(to, into = c("to_factor", "to_item"), 1) %>%
#        filter(from_factor == to_factor) %>%
#        select(age, weight, edge) %>%
#        spread(key = edge, value = weight) %>%
#        unclass %>% data.frame
       
# set the rownsames of these to age
# rownames(edges.mat50bw) <- edges.mat50bw$age
# rownames(edges.mat50wi) <- edges.mat50wi$age

##############################################
############ Profile Correlations ############
##############################################

# calculate profile correlations
# procor50bw <- cor(t(edges.mat50bw[,-1]), use = "pairwise.complete.obs")
# procor50wi <- cor(t(edges.mat50wi[,-1]), use = "pairwise.complete.obs")
```

## Profiles Correlation Plots (Figure 5){#Figure5}
```{r mt procor plots}
##############################################
################## PLOTS #####################
##############################################

procor_plot_fun <- function(df, inv, rule, set, gamma, type, leg){
  df[upper.tri(df, diag = T)] <- NA
  p <- tbl_df(df) %>% 
    mutate(age1 = colnames(.)) %>%
    gather(key = age2, value = r, 1:(ncol(.) - 1)) %>%
    filter(!is.na(r)) %>%
    ggplot(aes(x = age2, y = age1, fill = r)) + 
      geom_raster(aes(fill = r)) + 
      scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
       midpoint = .5, limit = c(0,1), space = "Lab", 
       name="Profile\nCorrelation") +
      labs(x = "Age", y = "Age", title = sprintf("Profile Correlations for %s", inv)) + 
      theme_classic() + 
      theme(legend.position = leg,
            axis.text = element_text(face = "bold"),
            axis.text.x = element_text(angle = 90, size = rel(.8)),
            plot.title = element_text(hjust = .5))
  # ggsave(p, file = sprintf("%s/photos/Big5_%s_profile_cors_heatmap.png", data_path, inv), width = 12, height = 8)
  # ggsave(p, file = sprintf("/Volumes/Emorie/projects/age nets/SAPA/02-results/01-plots/06-pro-cors/%s/png/%s-%s-%s-%s.png"
  #                          , type, inv, rule, set, gamma)
  #        , width = 12, height = 12)
  # ggsave(p, file = sprintf("/Volumes/Emorie/projects/age nets/SAPA/02-results/01-plots/06-pro-cors/%s/pdf/%s-%s-%s-%s.pdf"
  #                          , type, inv, rule, set, gamma)
         # , width = 12, height = 12)
  p
}

MT_procor <- MT_procor %>%
  mutate(plot = pmap(list(procor, inventory, rule, set, gamma, "all", "bottom"), procor_plot_fun)) 

bwwi_procor <- bwwi_procor %>%
  mutate(plot = pmap(list(procor, inventory, rule, set, gamma, type, "bottom"), procor_plot_fun)) 


# ggsave(p, file = sprintf("%s/photos/Big5_IPIP50_profile_cors_heatmap.png", data_path),
       # width = 12, height = 8)

```

```{r}
combine_plots_fun <- function(all, between, within, inv, rule, set, gamma){
  legend  <- cowplot::get_legend(all)
  all     <- all     + theme(legend.position = "none") + labs(title = inv)
  between <- between + theme(legend.position = "none") + labs(title = sprintf("%s: Between-Trait Edges", inv))
  within  <- within  + theme(legend.position = "none") + labs(title = sprintf("%s: Within-Trait Edges" , inv))
  
  p1 <- cowplot::plot_grid(within, between, nrow = 2, axis = "l")
  p2 <- cowplot::plot_grid(all, p1, ncol = 2, axis = "b", rel_widths = c(2/3,1/3))
  p <- cowplot::plot_grid(p2, legend, nrow = 2, rel_heights = c(.9, .1))
  
  ggsave(p, file = sprintf("/Volumes/Emorie/projects/age nets/SAPA/02-results/01-plots/06-pro-cors/png/%s-%s-%s-%s.png"
                           , inv, rule, set, gamma)
         , width = 12, height = 8)
  ggsave(p, file = sprintf("/Volumes/Emorie/projects/age nets/SAPA/02-results/01-plots/06-pro-cors/pdf/%s-%s-%s-%s.pdf"
                           , inv, rule, set, gamma)
  , width = 12, height = 8)
}

procor_plots <- MT_procor %>%
  select(-data, -procor) %>%
  rename(all = plot) %>%
  full_join(
    bwwi_procor %>%
      select(-data, -procor) %>%
      pivot_wider(names_from = "type"
                  , values_from = "plot")
  ) %>%
  mutate(p = pmap(list(all, between, within, inventory, rule, set, gamma), combine_plots_fun))
```

